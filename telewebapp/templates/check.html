
{% extends "base.html" %}
{% block content %}
  {% if message %}<div class="flash {{ 'error' if error else '' }}">{{ message }}</div>{% endif %}
  <form id="check-form" method="post" action="/check" enctype="multipart/form-data">
    <!-- –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è (—Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è) -->
    <input type="hidden" name="lat" id="geo-lat">
    <input type="hidden" name="lon" id="geo-lon">
    <input type="hidden" name="acc" id="geo-acc">
    <input type="hidden" name="geo_ts" id="geo-ts">
    <input type="hidden" name="dates_confirmed" id="dates-confirmed" value="0">
    <input type="hidden" name="ret_date" id="ret-date-hidden" value="">
    <input type="hidden" name="dep_date" id="dep-date-hidden" value="">
    <input type="hidden" name="not_return" id="not-return-hidden" value="0">

    
    

    <div class="form-row">
      <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
      <div class="badge">{{ fio }}</div>
    </div>

    <div class="form-row">
      <label for="action">–î–µ–π—Å—Ç–≤–∏–µ</label>
      <select id="action" name="action" required>
        <option value="start">üïó –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è</option>
        <option value="end">üèÅ –ö–æ–Ω–µ—Ü —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è</option>
        <option value="sick">üíä –ë–æ–ª—å–Ω–∏—á–Ω—ã–π</option>
        <option value="left">üöó –£–µ—Ö–∞–ª</option>
      </select>
    </div>

    <div class="form-row">
      <label for="photo">–§–æ—Ç–æ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <input id="photo" type="file" name="photo" accept="image/*" required>
    </div>

    <div class="row">
      <button class="button" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <!-- <a class="button secondary" href="/logout">–°–º–µ–Ω–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</a> -->
    
      <a class="button secondary" href="/brigade">–ë—Ä–∏–≥–∞–¥–∞</a>
      <a class="button secondary" href="/adjust">–î—Ä—É–≥–∏–µ –æ—Ç–º–µ—Ç–∫–∏</a>
    </div>

    <p class="small">–í—Ä–µ–º—è –±–µ—Ä—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ —Å–µ—Ä–≤–µ—Ä—É (MSK). –§–æ—Ç–æ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ –Ω—É–∂–Ω—É—é –≤–µ—Ç–∫—É Telegram.</p>
    <div id="modal-flag" data-show="{{ '1' if show_modal else '0' }}"></div>
  </form>

  <!-- –î–∏–∞–ª–æ–≥ –≥–µ–æ -->
  <div id="geo-blocker" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.65); z-index:9999;">
    <div style="max-width:520px; margin:10vh auto; background:#ffffff; color:#111; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35);">
      <h3 style="margin-top:0;">–ù—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏</h3>
      <p id="geo-blocker-msg" class="small">–î–ª—è –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞—á–∞–ª–∞/–∫–æ–Ω—Ü–∞ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å¬ª.</p>
      <div class="row" style="justify-content:flex-end; gap:8px;">
        <button id="geo-retry" class="button" type="button">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
      </div>
    </div>
  </div>


<!-- –ë–ª–æ–∫–∏—Ä—É—é—â–∞—è –ø–ª–∞—à–∫–∞ "–∏–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞" -->
<div id="busy-overlay" style="display:none; position:fixed; inset:0; z-index:10000; background:rgba(0,0,0,.66); backdrop-filter:saturate(1.2) blur(2px); touch-action:none; pointer-events:auto;">
  <div style="position:absolute; left:50%; top:40%; transform:translate(-50%,-50%); width:min(90vw,420px); text-align:center; background:#111; color:#fff; border-radius:16px; padding:22px 18px; box-shadow:0 10px 30px rgba(0,0,0,.45);">
    <div class="spinner" aria-hidden="true" style="margin:0 auto 12px;width:36px;height:36px;border-radius:50%;border:4px solid rgba(255,255,255,.25); border-top-color:#fff; animation:spin 1s linear infinite;"></div>
    <div id="busy-text" style="font-weight:600;">–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶</div>
    <div class="small" style="opacity:.85; margin-top:6px;">–ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç–∫—Ä–∞–Ω –∏ –Ω–µ –Ω–∞–∂–∏–º–∞–π—Ç–µ ¬´–ù–∞–∑–∞–¥¬ª</div>
  </div>
</div>

<!-- –î–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç (–ø–æ—Å–ª–µ "–£–µ—Ö–∞–ª") -->
<!-- –î–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç (–ø–æ—Å–ª–µ "–£–µ—Ö–∞–ª") -->
<div id="return-dialog" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:10000;">
  <div style="max-width:540px; margin:10vh auto; background:#111; color:#fff; border-radius:18px; padding:22px 20px; box-shadow:0 14px 40px rgba(0,0,0,.6);">
    <h3 style="margin:0 0 12px 0;">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã (–æ–±–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã)</h3>

    <div class="form-row">
      <label>–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è</label>
      <input id="ret-date" type="date" required>
    </div>

    <div class="form-row">
      <label>–°–ª–µ–¥—É—é—â–∏–π –æ—Ç—ä–µ–∑–¥</label>
      <input id="dep-date" type="date" required>
    </div>

    <div class="row" style="justify-content:flex-end; gap:8px; margin-top:14px;">
      <button type="button" id="btn-save-dates" class="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞—Ç—ã –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      <button type="button" id="btn-not-return" class="button secondary">–ù–µ –ø—Ä–∏–µ–¥—É</button>
      <!-- –ö–Ω–æ–ø–∫–∏ ¬´–ó–∞–∫—Ä—ã—Ç—å¬ª –±–æ–ª—å—à–µ –Ω–µ—Ç -->
    </div>

    <p id="ret-hint" class="small" style="margin-top:10px; color:#bbb;"></p>
  </div>
</div>



<style>
  @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
</style>


<script>
(function(){
  const form = document.querySelector("form[action='/check']") || document.querySelector("form");
  const lat = document.getElementById('geo-lat');
  const lon = document.getElementById('geo-lon');
  const acc = document.getElementById('geo-acc');
  const ts  = document.getElementById('geo-ts');

  const busy = document.getElementById('busy-overlay');
  const busyText = document.getElementById('busy-text');
  const dlg  = document.getElementById('return-dialog');
  const ret  = document.getElementById('ret-date');
  const dep  = document.getElementById('dep-date');
  const hint = document.getElementById('ret-hint');
  const btnSave = document.getElementById('btn-save-dates');
  const btnNotReturn = document.getElementById('btn-not-return');

  // –ì–µ–æ-–¥–∏–∞–ª–æ–≥
  const blocker = document.getElementById('geo-blocker');
  const blockerMsg = document.getElementById('geo-blocker-msg');
  const btnRetry = document.getElementById('geo-retry');

  let requesting = false;
  let allowDirectSubmit = false;

  function setBusy(text){
    if (text) busyText.textContent = text;
    busy.style.display = 'block';
  }
  function clearBusy(){ busy.style.display = 'none'; }
  function openDialog(){ hint.textContent = ''; dlg.style.display = 'block'; }
  function closeDialog(){ dlg.style.display = 'none'; }

  function hasFreshGeo(){
    const now = Date.now()/1000;
    const t = parseFloat(ts.value||'0');
    if (!lat.value || !lon.value || !t) return false;
    return (now - t) <= 60;
  }
  function explain(err){
    if (!err || typeof err.code !== 'number') return '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.';
    if (err.code === 1) return '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –æ—Ç–∫–ª–æ–Ω—ë–Ω.';
    if (err.code === 2) return '–ü–æ–∑–∏—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–¥–∞—Ç—á–∏–∫–∏/—Å–µ—Ç—å).';
    if (err.code === 3) return '–ò—Å—Ç–µ–∫ —Ç–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è.';
    return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.';
  }
  function showBlocker(msg){
    if (msg) blockerMsg.textContent = msg;
    blocker.style.display = 'block';
  }
  function hideBlocker(){ blocker.style.display = 'none'; }
  function fill(pos){
    const c = pos && pos.coords ? pos.coords : {};
    if (typeof c.latitude === 'number' && typeof c.longitude === 'number'){
      lat.value = String(c.latitude);
      lon.value = String(c.longitude);
      acc.value = c.accuracy != null ? String(c.accuracy) : '';
      ts.value  = String(pos.timestamp ? Math.floor(pos.timestamp/1000) : Math.floor(Date.now()/1000));
    }
  }
  function requestGeoOnce() {
    if (hasFreshGeo()) return Promise.resolve();
    if (requesting) {
      return new Promise((resolve, reject)=>{
        const id = setInterval(()=>{
          if(!requesting){
            clearInterval(id);
            hasFreshGeo()?resolve():reject(new Error('cancelled'));
          }
        }, 100);
      });
    }
    requesting = true;
    setBusy('–ü–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é‚Ä¶');
    return new Promise((resolve, reject)=>{
      if (!navigator.geolocation){
        requesting = false;
        clearBusy();
        return reject(new Error('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é'));
      }
      navigator.geolocation.getCurrentPosition(
        (pos)=>{ fill(pos); requesting = false; clearBusy(); resolve(); },
        (err)=>{ requesting = false; clearBusy(); reject(err); },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    });
  }

  btnRetry && btnRetry.addEventListener('click', async ()=>{
    try {
      await requestGeoOnce();
      hideBlocker();
      allowDirectSubmit = true;
      setBusy('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶');
      form.submit();
    } catch(e) {
      showBlocker('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é. ' + explain(e) + ' –ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å¬ª.');
    }
  });

  // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º submit —Ñ–æ—Ä–º—ã
  form && form.addEventListener('submit', async (ev)=>{
    if (allowDirectSubmit) { allowDirectSubmit = false; return; }
    const fd = new FormData(form);
    const action = (fd.get('action') || '').toString();

    if (action === 'left') {
      // –¢—Ä–µ–±—É–µ–º —Ä–µ—à–µ–Ω–∏–µ –≤ –º–æ–¥–∞–ª–∫–µ –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏
      if (document.getElementById('dates-confirmed').value !== '1') {
        ev.preventDefault();
        openDialog();
        return;
      }
      setBusy('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶');
      return;
    }

    if (action === 'start' || action === 'end') {
      if (hasFreshGeo()) {
        setBusy('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶');
        return;
      }
      ev.preventDefault();
      try {
        await requestGeoOnce();
        hideBlocker();
        allowDirectSubmit = true;
        setBusy('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶');
        form.submit();
      } catch(e) {
        showBlocker('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é. ' + explain(e) + ' –ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å¬ª.');
      }
      return;
    }

    // sick –∏ –ø—Ä–æ—á–∏–µ ‚Äî –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –≥–µ–æ
    setBusy('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶');
  }, { capture: true });

  // –ö–Ω–æ–ø–∫–∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞—Ç—ã –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª ‚Äî —Ç—Ä–µ–±—É–µ–º –û–ë–ï –¥–∞—Ç—ã
  btnSave && btnSave.addEventListener('click', ()=>{
    if (!ret.value || !dep.value) {
      hint.textContent = '–£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã: –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç—ä–µ–∑–¥–∞.';
      return;
    }
    document.getElementById('ret-date-hidden').value = ret.value;
    document.getElementById('dep-date-hidden').value = dep.value;
    document.getElementById('not-return-hidden').value = '0';
    document.getElementById('dates-confirmed').value = '1';

    closeDialog();
    setBusy('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶');
    form.submit();
  });

  // –í–ù–ò–ú–ê–ù–ò–ï: –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É ¬´–ù–µ –ø—Ä–∏–µ–¥—É¬ª –∫–∞–∫ –µ—Å—Ç—å (–Ω–µ –º–µ–Ω—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ)
  btnNotReturn && btnNotReturn.addEventListener('click', ()=>{
    document.getElementById('ret-date-hidden').value = '';
    document.getElementById('dep-date-hidden').value = '';
    document.getElementById('not-return-hidden').value = '1';
    document.getElementById('dates-confirmed').value = '1';

    closeDialog();
    setBusy('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶');
    form.submit();
  });

  // –î–æ–ø. –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ¬´–ù–µ –ø—Ä–∏–µ–¥—É¬ª —á–µ—Ä–µ–∑ /not_return ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
  btnNotReturn && btnNotReturn.addEventListener('click', async ()=>{
    try {
      const r = await fetch('/not_return', { method:'POST', body: new FormData() });
      await r.json().catch(()=>({}));
    } catch(e) {}
  });

  // –ê–≤—Ç–æ–ø–æ–∫–∞–∑, –µ—Å–ª–∏ –±—ã–ª —Ñ–ª–∞–≥
  const flag = document.getElementById('modal-flag');
  if (flag && String(flag.dataset.show) === '1') openDialog();
})();
</script>

<script src="/static/js/geo_watch.js"></script>
<script>
  const GEO_WATCH_ENABLE = {{ 'true' if geo_watch else 'false' }};
  if (GEO_WATCH_ENABLE && window.__geoWatch && typeof window.__geoWatch.startWatch === 'function') {
    setTimeout(async () => {
      // 1) —Å—Ç–∞—Ä—Ç—É–µ–º –ø–æ—Ç–æ–∫–æ–≤—É—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
      window.__geoWatch.startWatch();
      // 2) –≥–æ–≤–æ—Ä–∏–º —Å–µ—Ä–≤–µ—Ä—É "—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ, –±–æ–ª—å—à–µ –Ω–µ –∑–æ–≤–∏"
      try { await fetch('/api/geo/watch_ack', { method: 'POST' }); } catch (_) {}
    }, 300);
  }
</script>



  

{% endblock %}
