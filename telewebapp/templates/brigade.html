
{% extends "base.html" %}
{% block content %}
  <h2>–û—Ç–º–µ—Ç–∫–∞ –±—Ä–∏–≥–∞–¥—ã</h2>
  <p class="small">–í—ã: <strong>{{ fio }}</strong>. –û—Ç–º–µ—Ç—å—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö —Ñ–∏–∫—Å–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ/–∫–æ–Ω–µ—Ü —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è. –ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –æ–¥–Ω–æ —Ñ–æ—Ç–æ –≤ –≤–µ—Ç–∫—É –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.</p>

  {% set flash = request.session.get('brigade_flash') %}
  {% if flash %}
    <div class="flash">{{ flash.summary }}</div>
    <details style="margin: 8px 0;">
      <summary>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</summary>
      <ul style="margin:6px 0 0 16px;">
        {% for line in flash.details %}<li>{{ line }}</li>{% endfor %}
      </ul>
    </details>
    {% set _ = request.session.pop('brigade_flash') %}
  {% endif %}

  <form method="post" action="/brigade_check" enctype="multipart/form-data" style="margin-top: 12px;">
    <!-- –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è (—Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è) -->
    <input type="hidden" name="lat" id="geo-lat">
    <input type="hidden" name="lon" id="geo-lon">
    <input type="hidden" name="acc" id="geo-acc">
    <input type="hidden" name="geo_ts" id="geo-ts">

    <div class="form-row">
      <label>–î–µ–π—Å—Ç–≤–∏–µ</label>
      <select name="action" required>
        <option value="start">üïó –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è</option>
        <option value="end">üèÅ –ö–æ–Ω–µ—Ü —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è</option>
      </select>
    </div>

    <div class="form-row">
      <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</label>
      <div style="display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:8px;">
        {% for name in candidates %}
          <label style="display:flex;gap:8px;align-items:center;">
            <input type="checkbox" name="employees" value="{{ name }}">
            <span>{{ name }}</span>
          </label>
        {% endfor %}
      </div>
    </div>

    <div class="form-row">
      <label for="photo">–§–æ—Ç–æ (–æ–¥–Ω–æ –Ω–∞ –≤—Å–µ—Ö, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <input id="photo" type="file" name="photo" accept="image/*" required>
    </div>

    <div class="row">
      <button class="button" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <a class="button secondary" href="/">–ù–∞–∑–∞–¥</a>
    </div>
  </form>

  <!-- –î–∏–∞–ª–æ–≥ –≥–µ–æ -->
  <div id="geo-blocker" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.65); z-index:9999;">
    <div style="max-width:520px; margin:10vh auto; background:#ffffff; color:#111; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35);">
      <h3 style="margin-top:0;">–ù—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏</h3>
      <p id="geo-blocker-msg" class="small">–î–ª—è –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞—á–∞–ª–∞/–∫–æ–Ω—Ü–∞ –±—Ä–∏–≥–∞–¥—ã –Ω—É–∂–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å¬ª.</p>
      <div class="row" style="justify-content:flex-end; gap:8px;">
        <button id="geo-retry" class="button" type="button">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
      </div>
    </div>
  </div>


<!-- –ë–ª–æ–∫–∏—Ä—É—é—â–∞—è –ø–ª–∞—à–∫–∞ "–∏–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞" -->
<div id="busy-overlay" style="display:none; position:fixed; inset:0; z-index:10000; background:rgba(0,0,0,.66); backdrop-filter:saturate(1.2) blur(2px); touch-action:none; pointer-events:auto;">
  <div style="position:absolute; left:50%; top:40%; transform:translate(-50%,-50%); width:min(90vw,420px); text-align:center; background:#111; color:#fff; border-radius:16px; padding:22px 18px; box-shadow:0 10px 30px rgba(0,0,0,.45);">
    <div class="spinner" aria-hidden="true" style="margin:0 auto 12px;width:36px;height:36px;border-radius:50%;border:4px solid rgba(255,255,255,.25); border-top-color:#fff; animation:spin 1s linear infinite;"></div>
    <div id="busy-text" style="font-weight:600;">–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶</div>
    <div class="small" style="opacity:.85; margin-top:6px;">–ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç–∫—Ä–∞–Ω –∏ –Ω–µ –Ω–∞–∂–∏–º–∞–π—Ç–µ ¬´–ù–∞–∑–∞–¥¬ª</div>
  </div>
</div>
<style>
  @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
</style>


  <script>
  (function(){
    const form = document.querySelector("form[action='/brigade_check']") || document.querySelector("form");
    const lat = document.getElementById('geo-lat');
    const lon = document.getElementById('geo-lon');
    const acc = document.getElementById('geo-acc');
    const ts  = document.getElementById('geo-ts');

    const blocker = document.getElementById('geo-blocker');
    const blockerMsg = document.getElementById('geo-blocker-msg');
    const btnRetry = document.getElementById('geo-retry');

    const busy = document.getElementById('busy-overlay');
    const busyText = document.getElementById('busy-text');

    let requesting = false;
    let allowDirectSubmit = false;
    let loadingActive = false;

    function setBusy(text){
      if (text) busyText.textContent = text;
      busy.style.display = 'block';
      loadingActive = true;
      try { history.pushState({l:1}, ""); } catch(e){}
    }
    function clearBusy(){
      busy.style.display = 'none';
      loadingActive = false;
    }
    window.addEventListener('popstate', function(){ if (loadingActive) { try { history.pushState({l:1}, ""); } catch(e){} } }, {passive:true});

    function hasFreshGeo(){
      const now = Date.now()/1000;
      const t = parseFloat(ts.value||'0');
      if (!lat.value || !lon.value || !t) return false;
      return (now - t) <= 60;
    }
    function explain(err){
      if (!err || typeof err.code !== 'number') return '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.';
      if (err.code === 1) return '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –æ—Ç–∫–ª–æ–Ω—ë–Ω.';
      if (err.code === 2) return '–ü–æ–∑–∏—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–¥–∞—Ç—á–∏–∫–∏/—Å–µ—Ç—å).';
      if (err.code === 3) return '–ò—Å—Ç–µ–∫ —Ç–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è.';
      return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.';
    }
    function showBlocker(msg){
      if (msg) blockerMsg.textContent = msg;
      blocker.style.display = 'block';
    }
    function hideBlocker(){ blocker.style.display = 'none'; }
    function fill(pos){
      const c = pos && pos.coords ? pos.coords : {};
      if (typeof c.latitude === 'number' && typeof c.longitude === 'number'){
        lat.value = String(c.latitude);
        lon.value = String(c.longitude);
        acc.value = c.accuracy != null ? String(c.accuracy) : '';
        ts.value  = String(pos.timestamp ? Math.floor(pos.timestamp/1000) : Math.floor(Date.now()/1000));
      }
    }
    function requestGeoOnce() {
      if (hasFreshGeo()) return Promise.resolve();
      if (requesting) {
        return new Promise((resolve, reject)=>{
          const id = setInterval(()=>{
            if(!requesting){
              clearInterval(id);
              hasFreshGeo()?resolve():reject(new Error('cancelled'));
            }
          }, 100);
        });
      }
      requesting = true;
      setBusy('–ü–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é‚Ä¶');
      return new Promise((resolve, reject)=>{
        if (!navigator.geolocation){
          requesting = false;
          clearBusy();
          return reject(new Error('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é'));
        }
        navigator.geolocation.getCurrentPosition(
          (pos)=>{ fill(pos); requesting = false; clearBusy(); resolve(); },
          (err)=>{ requesting = false; clearBusy(); reject(err); },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    btnRetry && btnRetry.addEventListener('click', async ()=>{
      try {
        await requestGeoOnce();
        hideBlocker();
        allowDirectSubmit = true;
        setBusy('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶');
        form.submit();
      } catch(e) {
        showBlocker('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é. ' + explain(e) + ' –ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å¬ª.');
      }
    });

    form && form.addEventListener('submit', async (ev)=>{
      if (allowDirectSubmit) { allowDirectSubmit = false; clearBusy(); return; }
      const fd = new FormData(form);
      const action = (fd.get('action') || '').toString();
      if (action === 'start' || action === 'end') {
        if (hasFreshGeo()) {
          setBusy('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶');
          return;
        }
        ev.preventDefault();
        try {
          await requestGeoOnce();
          hideBlocker();
          allowDirectSubmit = true;
          setBusy('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶');
          form.submit();
        } catch(e) {
          showBlocker('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é. ' + explain(e) + ' –ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å¬ª.');
        }
      } else {
        setBusy('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶');
      }
    }, { capture: true });
  })();
  </script>
{% endblock %}
